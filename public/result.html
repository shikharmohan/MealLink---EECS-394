
<html>
  <head>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/parse/1.2.9/parse.min.js"></script>
  <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/ratchet/2.0.2/css/ratchet-theme-ios.css">
  <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/ratchet/2.0.2/css/ratchet-theme-ios.min.css">
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/ratchet/2.0.2/css/ratchet.css">
  <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/ratchet/2.0.2/css/ratchet.min.css">
  
  <script src="http://cdnjs.cloudflare.com/ajax/libs/ratchet/2.0.2/js/ratchet.js"></script>
  <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/ratchet/2.0.2/js/ratchet.min.js"></script>
  

  <!-- jquery ui -->
  <!-- <script src="./jquery-ui-1.9.2.js"></script> -->
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

<!--initialize parse --> 
<script>
  Parse.initialize("oOL3TebXo0CCT8Mm8OWN72Dq7H1LwNvaGrSUmZ8I","kYZjxpsriEyaK25EhmKw8TfrU9je7ycVcTI6DC65")
</script>


<!-- 10.15 zexian zeng add this part to get user information -->
  <script>
  if(Parse.User.current() == null)
  {
    window.location.href = "./index.html";
  }
  </script> 
<!-- 10.15 end of zexian zeng 's edition ' -->

<!-- 10.15 zexian zeng add this part to get user information -->
  <script>
    
  </script> 
<!-- 10.15 end of zexian zeng 's edition ' -->


    
    <!-- Makes your prototype chrome-less once bookmarked to your phone's home screen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <style>
    .btnEat{
      margin-left: 120px;
      margin-bottom: 10px;
      margin-top: 10px;
    }
      .btnSubmit{
      margin-left: 140px;
      margin-bottom: 10px;
      margin-top: 10px;
    }
    .divHeight1{
      height:50px;
      border:0px;

    }
    img{
      width:50px;
      height:50px;
      border-radius:30px;

    }
    .liPadding{
      padding-right:0px;
    }
    .person-name{
      display: inline-block;
      margin-left: 10px;
      font-size: 40px;
    }
    .availability{
      font-style:italic;
    }

    .distance {
      
    }
    </style>


    <title>My ParseApp site</title>
  </head>
  <body>
    
    <div class="segmented-control">
      <a href="#facebook_result" id="fb_sc" class="control-item active">Facebook</a>
      <a href="#linkedin_result" id="lk_sc" class="control-item">LinkedIn</a>
      <a href="#nearby_result" id="n_sc" class="control-item">Nearby</a>
    </div>
    <span id="facebook_result" class="control-content active">
    <ul class="table-view">
      <li class="table-view-cell" id = "fbCell1"><img src="https://fbcdn-profile-a.akamaihd.net/hprofile-ak-xpf1/v/t1.0-1/c195.55.548.548/s50x50/988686_10151585715386130_1175639374_n.jpg?oh=0ad7492d5c08fd97b343d36de3666062&oe=54AA97E2&__gda__=1424741424_90547460036388f6f7559e80cdffc03a">
        <div class="person-name">Person0</div> 
        <div class="availability">Available: 12:30PM</div>
        <div class='distance'>0.5 miles</div>
        <button class="smsbutton btn btn-primary">Say Hi!
        </button>
      </li>
    </ul>
    </span>
    <span id="linkedin_result" class="control-content">
    <ul class="table-view">
      <li class="table-view-cell">Linkedin <button class="btn">Button</button></li>
      <li class="table-view-cell">Item 22 <button class="btn btn-primary">Button</button></li>
      <li class="table-view-cell">Item 33 <button class="btn btn-positive">Button</button></li>
      <li class="table-view-cell">Item 44 <button class="btn btn-negative">Button</button></li>
    </ul>
    </span>

  <span id="nearby_result" class="control-content">
    <ul class="table-view">
    </ul>
  </span>

  <script>
  $("#fb_sc").on('click', function(){
    $("#fb_sc").addClass('active');
    $("#facebook_result").addClass('active');
    $("#linkedin_result").removeClass('active');
    $("#lk_sc").removeClass('active');
    $("#nearby_result").removeClass('active');
    $("#n_sc").removeClass('active');

    $("#facebook_result").show()
    $("#nearby_result").hide()
    $("#linkedin_result").hide()
  });
  $("#lk_sc").on('click', function(){
    $("#lk_sc").addClass('active');
    $("#linkedin_result").addClass('active');
    $("#facebook_result").removeClass('active');
    $("#fb_sc").removeClass('active');
    $("#nearby_result").removeClass('active');
    $("#n_sc").removeClass('active');

    $("#linkedin_result").show()
    $("#nearby_result").hide()
    $("#facebook_result").hide()
  });

  $("#n_sc").on('click', function(){
    $("#n_sc").addClass('active');
    $("#nearby_result").addClass('active');
    $("#facebook_result").removeClass('active');
    $("#fb_sc").removeClass('active');
    $("#linkedin_result").removeClass('active');
    $("#lk_sc").removeClass('active');

    $("#nearby_result").show()
    $("#linkedin_result").hide()
    $("#facebook_result").hide()
  });

  </script>
  

    <!-- 10/15 zexian add this to call function when paged loaded  -->
  </div>
    <script type="text/javascript">
      //function for loading all rows under Facebook tab
      function loadFacebookFriends() {
        var currentUser = Parse.User.current(); 
        var friends_list = currentUser.get('friends');  
        var friend_obj = JSON.parse(friends_list);
        
        var ids = [];
        for (var i = 0; i < friend_obj.length; i++){
          ids.push(friend_obj[i].id);
        }
        var friend_names = [];
        var friend_numbers = [];
        var friend_starttime = [];
        var friend_distance = [];
        var friend_pictures = [];
        var query = new Parse.Query("User");
        query.containedIn('fb_id', ids);
        query.find({
          success: function(results){
            for (var k = 0; k < results.length; k++)
            {
              var currFriend = results[k];
              friend_names.push(currFriend.get('name'));
              friend_numbers.push(currFriend.get('phone_number'));
              friend_starttime.push(currFriend.get('start_time'));
              friend_distance.push(currFriend.get('distance'));
              friend_pictures.push(currFriend.get('profile_picture'));

            }
            buildFacebookRows(friend_names, friend_numbers, friend_starttime, friend_distance, friend_pictures);
          },
          error: function(error){
            alert(JSON.stringify(error));
          }
        });
      }
      function buildFacebookRows(names, numbers, start, distance, pictures) {
        for(var i = 0; i < names.length; i++)
        {
          var hour = start[i].getHours();
          var minute = start[i].getMinutes();
          var AMPM = "AM";
          if(hour >= 12)
          {
            AMPM = "PM";
            hour = hour -12; 
          }
          //append all the users here
          $('#facebook_result').append("<ul class='table-view-cell' id = 'fbCell1'><img src='" + pictures[i] + "'>" + 
        "<div class='person-name'>" + names[i] + "</div>" +
        "<div class='availability'>Available: " + hour + ":" + minute + AMPM + "</div>" + 
        "<div class='distance'>" + distance[i] +" miles </div>" + 
        "<button class='smsbutton btn btn-primary'>Say Hi!" + 
        "</button></ul>")
        }
      }

//======================================================================================================================================

      //function for loading all rows under Nearby 
      function loadNearbyFriends() {
        var currentUser = Parse.User.current();
        var nearby_names = [];
        var nearby_numbers = [];
        var nearby_starttime = [];
        var nearby_distance = [];
        var nearby_pictures = [];
        var query = new Parse.Query("User");
        //restrict to all users less than 5 miles away
        query.lessThanOrEqualTo("distance", 5.0);
        query.notEqualTo("name",currentUser.get('name'));
        query.ascending('distance');
        query.find({
          success: function(results){
            for (var k = 0; k < results.length; k++)
            {
              var currStranger = results[k];
              nearby_names.push(currStranger.get('name'));
              nearby_numbers.push(currStranger.get('phone_number'));
              nearby_starttime.push(currStranger.get('start_time'));
              nearby_distance.push(currStranger.get('distance'));
              nearby_pictures.push(currStranger.get('profile_picture'));

            }
            buildNearbyRows(nearby_names, nearby_numbers, nearby_starttime, nearby_distance, nearby_pictures);
          },
          error: function(error){
            alert(JSON.stringify(error));
          }
        });
      }

      function buildNearbyRows(names, numbers, start, distance, pictures) {
        for(var i = 0; i < names.length; i++)
        {
          var hour = start[i].getHours();
          var minute = start[i].getMinutes();
          var AMPM = "AM";
          if(hour >= 12)
          {
            AMPM = "PM";
            if (hour!=12)
            {
              hour = hour -12; 
            }
            
          }
          //append all the users here
          $('#nearby_result').append("<ul class='table-view-cell' id = 'fbCell1'><img src='" + pictures[i] + "'>" + 
        "<div class='person-name'>" + names[i] + "</div>" +
        "<div class='availability'>Available: " + hour + ":" + minute + AMPM + "</div>" + 
        "<div class='distance'>" + distance[i] +" miles </div>" + 
        "<button id='" + names[i] +  "-" + numbers[i] + "' class='smsbutton btn btn-primary'>Say Hi!" + 
        "</button></ul>");
        }
      }
      loadFacebookFriends();
      loadNearbyFriends();


    </script>
    <!-- 10/15 zexian add this to call function when paged loaded  -->

    <script>


      //get the selected user and fields
      var selected_name;
      var selected_number;


      var query = new Parse.Query("User");
      query.equalTo('name', selected_name);
      query.first({
        success: function(object){
          selected_name = object.get('name');
          selected_number = object.get('phone_number');
        },
        error: function(error){
          alert(JSON.stringify(error));
        }
      });

      $( document ).on( "click", ".smsbutton", function() {
        id = $(this).attr('id');
        arr = id.split("-");
        selected_name = arr[0];
        selected_number = arr[1];
        console.log("button works");

        var currentUser = Parse.User.current();
        var user_time = currentUser.get('start_time');
        var user_hour = user_time.getHours();
        var user_minute = user_time.getMinutes();
        var user_number = currentUser.get('phone_number');

        var msg = "Hi " + selected_name + "! I'm available at " + user_hour + ":" + user_minute + ". Message me back at " + user_number + "!" 
        var sendtonumber = "shikhar@u.northwestern.edu";
        Parse.Cloud.run('sendSMS', { smsmessage: msg, number: sendtonumber}, {
          success: function(result) {
            // result is 'Hello world!'
            console.log("" + JSON.stringify(result));
          },
          error: function(error) {
            console.log("" + JSON.stringify(error));
          }
        });

      })


    </script>
   
  </body>
</html>
